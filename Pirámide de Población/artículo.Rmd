---
title: "Visualizando pir치mides de poblaci칩n en R"
author: Juvenal Campos
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(fig.width=12, fig.height=8) 
```

Las pir치mides de poblaci칩n (o _pir치mide demogr치fica_, como le dicen los dem칩grafos) son un tipo de gr치fica que nos permite analizar la distribuci칩n de la poblaci칩n por edades en una regi칩n determinada (municipio, estado o pa칤s).

Desde el punto de vista gr치fico, se trata de un doble histograma de frecuencias, dispuestos de manera horizontal, donde convencionalmente **se ponen los grupos de edad masculina a la izquierda y los de poblaci쑕 femenina a la derecha**. En el eje _y_ (el de las ordenadas o el que va para arriba) se disponen los grupos de edad, moentras que en el eje _x_ (el de las ordenadas, o el que va horizontal) van las cantidades de poblaci칩n. Para m치s informaci칩n recomiendo leer este art칤culo de [Wikipedia](https://es.wikipedia.org/wiki/Pir치mide_de_poblaci칩n). 

Desde el punto de vista de visualizaci칩n de datos en R y a pesar de la gran utilidad y amplio uso de este tipo de gr치ficas, no hay una funci칩n `geom_popPyramid()` nativa en `ggplot2` que nos permita hacer pir치mides de poblaci칩n sin tanto dolor (aunque podr칤amos programarla 游땚). Sin embargo, en esta entrada de blog, nos dispondremos a generar una de estas gr치ficas a partir de elementos ya conocidos de esta librer칤a. 

## 1. Antecedentes. 

El viernes pasado estaba intentando hacer una de estas gr치ficas de poblaci칩n en mi trabajo, siendo (como casi siempre) mi primer impulso buscar en Google _"como graficar pir치mides de poblaci칩n en R"_. Estos son algunos de los tutoriales y art칤culos que me ayudaron: 

* http://r-statistics.co/Top50-Ggplot2-Visualizations-MasterList-R-Code.html

* https://klein.uk/teaching/viz/datavis-pyramids/

* https://stackoverflow.com/questions/38268741/geom-bar-ggplot2-stacked-grouped-bar-plot-with-positive-and-negative-values-p

* https://stackoverflow.com/questions/4559229/drawing-pyramid-plot-using-r-and-ggplot2

Todos son muy buenos y sirven para complementar esta entrada. El problema que tuve al checarlos fu칠 que 1) muchas funciones no estaban actualizadas y 2) las bases de datos eran inaccesibles, por lo que era imposible reproducir los ejemplos presentados. Es por eso que aqu칤 presentamos una tercera opci칩n (y en espa침ol :3) para aquellos que tengan la necesidad de hacer una gr치fica de poblaci칩n en el futuro. 

# 2. Descripci칩n del problema. 

Vamos a elaborar la pir치mide de poblaci칩n del Estado de Morelos, M칠xico a partir de los datos reportados por la _Encuensta Intercensal 2015_ del INEGI en sus tabulados de Poblaci칩n. 

## 2.1. Descarga de los datos. 

Descargamos los datos de poblaci칩n de la p치gina de la encuesta intercensal 2015. 

La liga de descarga es la siguiente: 

https://www.inegi.org.mx/contenidos/programas/intercensal/2015/tabulados/01_poblacion_mor.xls

(En caso de que alg칰n gobierno austero decida eliminar las bases de datos de INEGI por alg칰n motivo en los pr칩ximos a침os, igualmente guardar칠 una copia en mi Github de los datos).

_**Nota 1.** Se supone que el lector sabe descargar librerias del CRAN._ 

```{r}
# Descarga de los datos.
library(curl)
library(readxl)

curl::curl_download(url = "https://www.inegi.org.mx/contenidos/programas/intercensal/2015/tabulados/01_poblacion_mor.xls", destfile = "mor_pop.xls")

# Leemos datos
# Por tama침o de localidad
bd <- read_xls("mor_pop.xls", sheet = 2, skip = 6)
```

La funci칩n anterior descargar치 el archivo en nuestro directorio de trabajo. La hoja 2 es la que contiene la poblaci칩n _Por tama침o de localidad_ y las 6 l칤neas que se saltaron contienen el encabezado de logotipos que INEGI le pone a muchas de sus tablas. 

## 2.2. Procesado de la informaci칩n. 

Necesitamos obtener una tabla adecuada para realizar nuestra gr치fica, tal como se explica en el siguiente esquema: 

<img src = "Imagenes/tablaFinal.png" width = 500px>

Este esquema nos permite declarar una columna 칰nica de una sola base de datos, y declarar estas columnas dentro de los est칠ticos globales del ggplot como se ve m치s adelante.

Para lograr esto, haremos el siguiente procesado de la informaci칩n a trav칠s de la funci칩n `tidyr::pivot_longer()`: 

![](Imagenes/TablaPivote.png)
 

```{r, message=FALSE, cache=FALSE, warning=FALSE}
# Librerias
library(tidyverse)
library(tidyr)

# Procesamos datos
pop <- bd %>%
# Filtramos los renglones vacios, 
# los renglones donde el Tama침o de localidad` es el Total y 
# los `Grupos quinquenales de edad` son todos "Total"    
  filter(!is.na(Estimador) &
           Estimador == "Valor" &
           `Tama침o de localidad` == "Total" &
           `Grupos quinquenales de edad` != "Total") %>%
# Hacemos pivot longer rotando las columnas hombres y mujeres    
  pivot_longer(cols = c("Hombres", "Mujeres"),
               names_to = "Sexo",
               values_to = "Poblacion por Sexo") %>% 
# Nos quedamos con columnas utiles  
  select(`Entidad federativa`, `Grupos quinquenales de edad`, 
         `Poblaci칩n total`, Sexo, `Poblacion por Sexo`)

```

```{r, eval = FALSE}
# Checamos la base 
pop
```

```{r, eval = TRUE, echo = FALSE}
# Checamos la base 
pop %>% 
  DT::datatable(options = list(
  language = list(url = '//cdn.datatables.net/plug-ins/1.10.11/i18n/Spanish.json'),
  pageLength = 5))
```


Ahora que tenemos la base como la necesitamos, procedemos a hacer la gr치fica. 

## 2.3. Graficando con `ggplot()`.

Para graficar utilizamos la funci칩n `ggplot()`.

## Primera versi칩n: utilizando `geom_bar()`.

La primera versi칩n que realizaremos ser치 utilizando la funci칩n `geom_bar()`. Esta funci칩n nos permite realizar gr치ficas de barras en R. 

```{r}
### Grafica ----
ggplot(pop, aes(x = `Grupos quinquenales de edad`,
                y = `Poblacion por Sexo`,
                fill = Sexo)) +
  geom_col(data = subset(pop, Sexo == "Hombres") %>% 
             mutate(`Poblacion por Sexo` = -`Poblacion por Sexo`),
              width = 0.5, fill = "blue") +
  geom_col(data = subset(pop, Sexo == "Mujeres"),
           width = 0.5, fill = "pink") + 
  coord_flip()

```


<b style = 'color:red; text-align:center;'>N칩tese las escalas del eje _x_</b>

Ahora, tenemos que enfocarnos en la parte del eje de poblaci칩n. Primero que nada, tenemos que hacer un poco de an치lisis. 

```{r}

# Valores maximos de poblaci칩n: 
max(pop$`Poblacion por Sexo`)
```

El m치ximo de poblaci칩n es 88,967 personas (correspondiente a Mujeres morelenses entre 20 a 24 a침os). Para el eje `x`, vamos a poner escalas cada 20,000 personas (para que sean unas 5 marcas en las escalas). 

```{r}
# BREAKS - DEFINEN LA POSICI칍N 
# Obtenemos los puntos donde se van a poner las escalas de la poblaci칩n. 
seq(0, 100000, by = 20000)
seq(-100000, -20000, by = 20000)

# Secuencia de puntos donde se van a poner las escalas del eje x
c(seq(-100000, -20000, by = 20000), seq(0, 100000, by = 20000))

```

Como vemos arriba, es una secuencia que va desde -100,000 hasta 100,000. Esto implica que, dentro de la gr치fica, `ggplot()` va a poner las etiquetas en los puntos marcados arriba, como puede verse en la siguiente im치gen: 

**Im치gen de donde se van a marcar las etiquetas**.

Ahora, pongamosle las etiquetas en los puntos que determinamos arriba, a trav칠s de la funci칩n 

```{r}
# LABELS - DEFINEN EL CONTENIDO

c(seq(-100000, -20000, by = 20000) * -1, seq(0, 100000, by = 20000)) 

```

Para este caso, las etiquetas son casi iguales que los quiebres que calculamos arriba, con la diferencia de que la parte de la poblaci칩n masculina tienen que ser positivos, no negativos (por eso los multiplicamos por -1). 

Ahora, incorporamos esto en la gr치fica que ya hicimos arriba a trav칠s de la funci칩n `scale_y_continuous()`.

Empezamos declarando los elementos est칠ticos. Los est칠ticos globales que vamos a usar son el `x`, el `y`, y el `fill`. `x` nos determinar치 la variable categ칩rica que ir치 en el eje x, `y` la variable num칠rica que ir치 en el eje `y` y `fill` la variable categ칩rica que clasifica a los datos en dos categor칤as, `Hombres` y `Mujeres`, asignando un color distinto a cada tipo de dato. 

```{r, eval = FALSE}
# No correr! Abajo est치 completo.
ggplot(pop, aes(x = `Grupos quinquenales de edad`,
                y = `Poblacion por Sexo`,
                fill = Sexo))
```

Despu칠s a침adimos las gr치ficas de columnas mediante la funci칩n `geom_col()` con subconjuntos de los datos filtrando por hombres y mujeres. Despu칠s hacemos un cambio de ejes y al final a침adimos las etiquetas en los ejes de las gr치ficas. A continuaci칩n el c칩digo completo. 

```{r}
### Grafica ----
(plt <- ggplot(pop, aes(x = `Grupos quinquenales de edad`,
                y = `Poblacion por Sexo`,
                fill = Sexo)) +
  # Seccion de HOMBRES
  geom_col(data = subset(pop, Sexo == "Hombres") %>% 
             # Convertimos los datos de los Hombres en negativos
             mutate(`Poblacion por Sexo` = -`Poblacion por Sexo`),
         width = 0.5, fill = "blue") +
  # Seccion de MUJERES
  geom_col(data = subset(pop, Sexo == "Mujeres"),
         width = 0.5, fill = "pink") + 
  # Cambio de ejes de coordenadas
  coord_flip() + 
     scale_y_continuous(
     breaks = c(seq(-100000, -20000, by = 20000), seq(0, 100000, by = 20000)),
     labels = c(seq(-100000, -20000, by = 20000) * -1, seq(0, 100000, by = 20000))) )

```

Ya a partir de aqu칤 lo que procede es personalizar el tema y las etiquetas. 

## 2.4. Se puede graficar en plotly

R: Si. Este tipo de gr치ficas se pueden traducir a `plotly`, quedando como se ve a continuaci칩n. 

```{r, echo=FALSE,fig.width=8}
plotly::ggplotly(plt)
```

## 2.5. Segunda versi칩n: utilizando `geom_linerange()`.

Otra versi칩n muy com칰n de las gr치ficas de pir치mides de poblaci칩n consiste en poner los grupos de edad en el centro de la gr치fica. Esto no es posible de realizar con las barras normales de `ggplot`, por lo que utilizaremos un elemento gr치fico llamado `geom_linerange()`, el cual nos permite representar de manera gr치fica intervalos con inicio y final. 

La 칰nica diferencia entre el metodo anterior y el que viene a continuaci칩n, consiste en 1) Cambiar el `geom_col()` por un `geom_linerange()`, incluir dentro el `aes(ymin, ymax)` y 3) tambi칠n introducir como etiquetas de texto en el centro de la gr치fica con `geom_label()`.

Igualmente, hay que programar un `desplazamiento` de las barras a la derecha y a la izquierda, para dejar el espacio para las etiquetas que van a ir en el centro. Para la gr치fica que queremos hacer dejaremos un desplazamiento de 10,000 unidades de poblaci칩n (la magnitud de este desplazamiento depende de los datos del eje _y_, en este caso de los n칰meros de poblaci칩n). 

Se escogi칩 10,000 como desplazamiento porque as칤 cabe bien el texto de las categorias de edad. 

```{r}
### Grafica ----
desplazamiento <- 10000
```

Para este caso modificaremos ligeramente las etiquetas: 

```{r}
# BREAKS
c(seq(-180000, 0, by = 30000) - desplazamiento,
                seq(0, 180000, by = 30000) + desplazamiento)
```

Estas ser치n las nuevas coordenadas dentro del eje X en las que se van a colocar las nuevas etiquetas. Es lo mismo que con las anteriores, solo que sumandole/rest치ndole el desplazamiento. 

```{r}
# LABELS
c(rev(seq(0, 180000, by = 30000)), seq(0, 180000, by = 30000))

```

Ahora si, hacemos la gr치fica: 

```{r}
# Graficamos
ggplot(pop, aes(x = `Grupos quinquenales de edad`,
                y = `Poblacion por Sexo`,
                fill = Sexo)) +
  geom_linerange(data = subset(pop, Sexo == "Hombres") %>% 
                   # Convertimos los datos de los Hombres en negativos
                 mutate(`Poblacion por Sexo` = -`Poblacion por Sexo`),
                 aes(ymin = -desplazamiento, 
                     ymax = -desplazamiento +`Poblacion por Sexo`),
                 size = 5, 
                 color = "blue") +
  geom_linerange(data = subset(pop, Sexo == "Mujeres"),
                 aes(ymin = desplazamiento, 
                     ymax = desplazamiento  +`Poblacion por Sexo`),
                 size = 5, 
                 color = "pink") +
  # Cambiamos el orden de los ejes de la graficas 
  coord_flip()  +
   scale_y_continuous(
     breaks = c(seq(-180000, 0, by = 30000) - desplazamiento,
                seq(0, 180000, by = 30000) + desplazamiento),
     labels = c(rev(seq(0, 180000, by = 30000)),
               seq(0, 180000, by = 30000))) +
  # Eliminamos el texto del eje x volteado
   theme(plot.title = element_text(hjust = .5),
        axis.ticks = element_blank(),
        axis.text.y = element_blank()
        ) +   # Centre plot title
   # Aniadimos la escala de texto en el centro. 
   geom_label(aes(x = `Grupos quinquenales de edad`, 
                  y = 0, 
                  label = `Grupos quinquenales de edad`),
   # Caracteristicas del texto             
             family = "Arial",
             size = 3.5, 
             label.padding = unit(0.0, "lines"), 
             label.size = 0,
             label.r = unit(0.0, "lines"), 
             fill = "#FFFFFF", 
             alpha = 0.9, 
             color = "#5D646F")
```

## 2.6. Qu칠 sigue? 

Lo que sigue a continuaci칩n es embellecer la gr치fica modificando los temas: fondo de la gr치fica, tipo de letra, colores, etc. Igualmente, a침adir formato a los n칰meros, poner t칤tulos, subt칤tulos y pies de p치gina, modificar los colores (quiz치 el rosa para mujeres y azul para hombres no parezca tan adecuado), entre alguna otra funci칩n a침adida que nos interese agregar. 

Una de las ventajas de hacer visualizaciones en c칩digo es que es dif칤cil solo la primera vez. Una vez que ya tenemos el c칩digo, podemos tenerlo guardado para hacer otras gr치ficas cuando salgan nuevos datos de poblaci칩n (alguien dijo censo 2020?) o que podemos utilizarlo para graficar otros datos (por ejemplo, pir치mides para municipios dentro de un estado o de otros estados, o por tama침os de comunidad). O ya de plano construir una aplicaci칩n en _Shiny_ para que el usuario haga las pir치mides de poblaci칩n que quiera. 

