---
title: "Distancia punto a l√≠nea"
author: "Juvenal Campos"
date: "2/13/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

La semana pasada, mientras estaba yo muy a gusto en mi trabajo limpiando bases de datos, un amigo m√≠o muy querido (y aparte, mi ex-jefe) Jes√∫s Carrillo [@ProfeTriste](https://twitter.com/ProfeTriste) me lanz√≥ el siguiente reto: 

![](conversacionJesus.png)

Y pues bueno, al terminar la jornada laboral (obviamente) me dediqu√© a resolver este reto (porque, si bien ten√≠a la idea, nunca lo hab√≠a realizado).

## Paso 1. Descargar la informaci√≥n. 

Primero hab√≠a que descargar la informaci√≥n de la frontera norte de M√©xico a mi computadora. La primera opci√≥n que pens√© hacer fu√© filtrar las l√≠neas superiores de un shape de los estados del pa√≠s, pero si lo piensas un poco... ¬øcomo podr√≠a decirle a R cual es la l√≠nea superior de un estado? ¬øSeleccionando los puntos m√°s extremos en el eje Y?

Pues tal vez esa podr√≠a ser una opci√≥n, pero el algoritmo de Googlear la base y descargar la base result√≥ m√°s efectivo. 

Si eres de los que les d√° flojera ir a la p√°gina, descargar archivos, ir a la carpeta de _Descargas_, y mover el archivo a la carpeta de trabajo, puedes utilizar el c√≥digo de abajo (obviamente, descargando primero el paquete `curl` del CRAN).

```{r, message=FALSE, cache=FALSE,warning=FALSE}
# Descarga datos automaticamente, si te da flojera darle cl
curl::curl_download("https://opendata.arcgis.com/datasets/e735940321bd4383bab528a91bf526f8_0.zip?outSR=%7B%22latestWkid%22%3A3857%2C%22wkid%22%3A102100%7D",
destfile = "frontera.zip")
```

Esto me descarg√≥ un archivo `*.zip`, que yo nombr√© como `frontera.zip`, en mi directorio de trabajo. Como ya caduc√≥ mi licencia de WinRar üòî y no puedo descomprimirlo en la computadora, utilizo el siguiente c√≥digo para extraer la informaci√≥n: 

```{r, message=FALSE, cache=FALSE,warning=FALSE}
# Deszipeado
unzip(zipfile = "frontera.zip")
```

Una vez descomprimido, tengo ahora un mont√≥n de archivos en mi directorio de trabajo llamados `Mexico_and_US_Border` con distintas extensiones, tales como `*.shp`, `*.shx` o `*.dbf`. Estos archivos son la manera en que se guardan las bases de datos geogr√°ficas (formato `shapefile`), y estos archivos se pueden abrir desde R con la librer√≠a `sf`.

## Paso 2. Abriendo los datos. 

Para abrir la base de datos de la frontera norte, usamos la funci√≥n `sf::st_read()` como se ve a continuaci√≥n: 

```{r, message=FALSE, cache=FALSE,warning=FALSE}
# Librerias
library(sf)
library(tidyverse)
# Apertura del archivo (solo abrimos el archivo *.shp)
f <- st_read("Mexico_and_US_Border.shp")
```

Y ya. as√≠ lo abrimos. Para corroborar que sea efectivamente un archivo geogr√°fico, lo ploteamos (dibujamos): 

```{r, message=FALSE, cache=FALSE,warning=FALSE}
# Ploteado (te recomiendo que no le muevas al max.plot = 1)
plot(f, max.plot = 1)
```

## 3. Definiendo el punto. 

Ahora hay que determinar el punto al cual le vamos a sacar la distancia respecto de la frontera norte: como mi amigo es estudiante del Colmex, vamos a calcular la distancia de El Colegio de M√©xico a un punto (el m√°s cercano) a la frontera norte.

Para sacar las coordenadas del Colmex, lo buscamos en Google Maps, y le picamos encima de la biblioteca para sacar sus coordenadas: 

![](coordColmex.png)

Ahora, creamos una tabla que almacene estas coordenadas latitud/longitud: 

```{r, message=FALSE, cache=FALSE,warning=FALSE}
# Las coordenadas del Colmex en formato tabla-dataframe
pto <- data.frame(x = -99.20775, y = 19.303741) %>% 
  st_as_sf(coords = c("x", "y")) 

# Homologamos el Sistema de Coordenadas de Referencia con la base de la l√≠nea de la Frontera Norte
st_crs(pto) <- st_crs(f)
```

## 4. Calculamos la distancia. 

Ahora calculamos la distancia. 

```{r, message=FALSE, cache=FALSE,warning=FALSE}
st_distance(pto, f) 
```

Y si, la distancia de El Colmex a el punto m√°s cercano de la frontera norte (qui√©n sabe cual) es de 746.6889 km ( _746688.9_ m). 

Y ah√≠ est√° la respuesta a la distancia. **Fin**. 

## 5. ¬øA qu√© punto se calcul√≥ la distancia? 

Pero ahora pueden surgir preguntas muy l√≥gicas sobre esta respuesta... _¬øQu√© m√©todo utiliza R para calcular esta distancia?_, _¬øA qu√© punto de la frontera se le calcul√≥ la distancia?_ 

Entonces, hagamos el c√°lculo m√°s detenidamente, para esto, propongo descomponer la l√≠nea de la frontera norte en sus v√©rtices: 

```{r, message=FALSE, cache=FALSE,warning=FALSE}
# Descomponemos la linea en sus coordenadas
ptos_linea <- st_coordinates(f) %>%
  as.data.frame() %>%
  st_as_sf(coords = c("X", "Y")) 

st_crs(ptos_linea) <- st_crs(f)

class(ptos_linea)
st_crs(ptos_linea)
```

Y ahora calculamos las distancias del Colmex a todos los v√©rtices de la frontera norte: 

```{r, message=FALSE, cache=FALSE,warning=FALSE}
distancias <- st_distance(ptos_linea, pto)
head(distancias)
```

Y ahora, sacamos la l√≠nea con la menor longitud: 

```{r, message=FALSE, cache=FALSE,warning=FALSE}
# Obtencion de la distancia minima
distancia_minima <- min(distancias) 

# En kilometros
(distancia_minima / 1000) %>% as.numeric()
```

Como podemos ver, la distancia m√≠nima es la misma distancia que calcula la funci√≥n `st_distance()`. Ahora, ¬øcu√°l punto de todos esos es el punto m√°s cercano al Colmex? Para esto, filtramos las distancias hasta quedarnos aquella observaci√≥n que tenga la distancia igual a la distancia m√≠nima. 

```{r, message=FALSE, cache=FALSE,warning=FALSE}
# Punto minimo
punto_frontera <- 
  ptos_linea[distancias == distancia_minima,]
```

Y para visualizarlo, creamos una l√≠nea que va del Colmex a dicho punto: 

```{r, message=FALSE, cache=FALSE,warning=FALSE}
# linea de distancia
linea <- st_linestring(matrix(c(pto[,"geometry"] %>% 
                              st_coordinates(), 
                              punto_frontera[,"geometry"] %>% st_coordinates()), ncol = 2, byrow = TRUE))
```

Y lo hacemos en un mapa: 

```{r, message=FALSE, cache=FALSE,warning=FALSE}
library(leaflet)

# Hacemos el mapa 
leaflet() %>% 
  addTiles() %>% 
  addCircleMarkers(data = pto) %>% 
  addCircleMarkers(data = punto_frontera) %>% 
  addPolylines(data = linea) %>% 
  addPolylines(data = f, color = "red")
```

Y resulta (haciendo zoom podemos darnos cuenta) que el punto m√°s cercano a la frontera norte se encuentra unos kil√≥metros al Este de la Ciudad de Matamoros, en el Estado de Tamaulipas. 

## 6. ¬øY si quiero calcular la distancia a otro punto? 

Para hacerlo para cualquier punto de M√©xico, hacemos una funci√≥n. Las funciones son pedazos de c√≥digo que, entre otras cosas, se programan para llevar a cabo tareas repetitivas (como todo lo que hicimos arriba). Primero, empezaremos haciendo una funci√≥n para calcular solamente las distancias a la frontera. 

```{r, message=FALSE, cache=FALSE,warning=FALSE}
# Funci√≥n para calcular las distancias. 
distancia <- function(X, Y){
  pto <- data.frame(x = X, y = Y) %>% 
          st_as_sf(coords = c("x", "y")) 
        st_crs(pto) <- st_crs(f)
  st_distance(pto, f)       
}

# Distancia a un punto del mpio de Mexicali, BC
distancia(X = -115.418556, Y = 31.795112)

# Distancia a Puerto Pe√±asco, Sonora
distancia(X = -113.534104, Y = 31.309766)

# Distancia al CIDE
distancia(X = -99.263426, Y = 19.374515)

# Distancias a todos estos puntos 
distancia(X = c(-115.418556,-113.534104, -99.263426), 
          Y = c(31.795112, 31.309766, 19.374515))

```

## 7. ¬øY la trayectoria? 

Y ahora, haremos otra funci√≥n para dibujar las l√≠neas. Esta funci√≥n va a empaquetar todos los pasos que segu√≠mos para determinar el punto de la frontera al cual llegaba la l√≠nea con la distancia m√≠nima. 

```{r, message=FALSE, cache=FALSE,warning=FALSE}

# Funcion para dibujar las lineas de minima distancia
# Nota, esta funci√≥n asume que previamente ya cargamos 
# la base de datos de la frontera y la almacenamos en el objeto f
dibuja_lineas_minima_distancia <- function(X,Y){

  # Creamos el punto a partir de los argumentos X y Y
  pto <- data.frame(x = X, y = Y) %>% 
        st_as_sf(coords = c("x", "y")) 

  # Homologamos el Sistema de Coordenadas de Referencia
  st_crs(pto) <- st_crs(f)
  
  # Extraemos los v√©rtices de la linea
  ptos_linea <- st_coordinates(f) %>%
    as.data.frame() %>%
    st_as_sf(coords = c("X", "Y")) 
  
  # Homologamos el Sistema de Coordenadas de Referencia
  st_crs(ptos_linea) <- st_crs(f)

  # Sacamos las distancias del punto a todos los vertices de la frontera
  distancias <- st_distance(ptos_linea, pto)

  # Obtencion de la distancia minima
  distancia_minima <- min(distancias) 

  # Guardamos el punto de la frontera con la distancia minima
  punto_frontera <<- 
    ptos_linea[distancias == distancia_minima,]

  # Construimos la linea de distancia minima
  linea <- st_linestring(matrix(c(pto[,"geometry"] %>% 
                                st_coordinates(), 
                                punto_frontera[,"geometry"] %>%       st_coordinates()), ncol = 2, byrow = TRUE))  
  
  # Seleccionamos la linea como objeto a retornar de la funcion 
  return(linea)
  
}

# Probamos la funcion, sacando la linea del CIDE a la frontera
lineaCIDE <- dibuja_lineas_minima_distancia(X = -99.263426, Y = 19.374515)
class(lineaCIDE)
leaflet(lineaCIDE) %>% addTiles() %>% addPolylines(color = "#005700")

```

Pues ahora tenemos una funci√≥n que nos calcula la distancia y las l√≠neas. Ahora, a partir de estas funciones, cualquier programador experimentado de R puede calcular las distancias y la trayectoria en l√≠nea recta a la frontera a partir de solo tener las coordenadas `X` y `Y` del punto de inter√©s, y copipegando las funciones de arriba en su sesi√≥n de RStudio.  

## 8. ¬øY si hacemos un shiny?  

Bueno, y ¬øsi hacemos una soluci√≥n en la cual cualquier usuario pueda calcular la distancia de cualquier punto a la frontera sur de Estados Unidos? Esto lo vamos a lograr con la librer√≠a `shiny` y pegando todo el c√≥digo que hemos hecho arriba. 

```{r, message=FALSE, cache=FALSE,warning=FALSE}
knitr::include_app("https://lnppmicrositio.shinyapps.io/distanciaAFrontera/")
```
